# 项目模板使用指南（NestJS + AWS CDK）

本指南面向使用本模板快速搭建「NestJS 后端应用 + AWS CDK 基础设施」的开发者，涵盖本地开发与多环境部署的常见流程与注意事项。

- 技术栈：NestJS、TypeScript、AWS CDK、API Gateway + Lambda、DynamoDB、S3、Cognito
- 仓库结构：Yarn Workspaces Monorepo（`backend` 应用 + `infrastructure` 基础设施）

## 目录结构

```
├── backend/                  # NestJS 应用（源码、构建、测试）
├── infrastructure/           # AWS CDK 工程（部署、对比、销毁）
├── scripts/                  # 构建与部署脚本（含 Lambda 打包）
├── docs/                     # 文档与说明
├── lambda-package/           # Lambda 打包产物（由脚本生成）
├── package.json              # 根工作区脚本（统一入口）
└── yarn.lock                 # Yarn 锁文件（推荐使用 Yarn）
```

更多背景参考：`README.md`、`docs/ENVIRONMENT_SETUP.md`、`docs/CDK_OUTPUT_EXAMPLE.md`。

---

## 如何开发（本地）

### 1. 环境准备
- Node.js 20+
- Yarn（推荐）或 npm
- AWS CLI v2（已配置凭证：`aws configure`）
- AWS CDK v2：`npm i -g aws-cdk`

### 2. 安装依赖
```bash
# 在仓库根目录执行（推荐 Yarn）
yarn
# 或使用 npm（npm 7+ 支持 workspaces）
npm install
```

### 3. 配置环境变量
```bash
# 根目录模板
cp .env.example .env
# 本地运行时，NestJS 会从 backend/.env*. 文件加载变量
yes | cp .env backend/.env  # 或手动创建 backend/.env
```
常用变量见 `README.md` 的「Environment Variables」章节；不要提交私密信息到仓库。

### 4. 启动开发服务
```bash
# 方式 A：通过根脚本（调用 workspace）
npm run backend:start:dev

# 方式 B：进入应用目录
yarn workspace backend start:dev
# 或
cd backend && npm run start:dev
```
默认运行地址：
- API Base: `http://localhost:3000/api/v1`
- Swagger: `http://localhost:3000/api/v1/docs`（非生产环境自动开启）

### 5. 常用开发脚本
```bash
# 构建应用（仅编译，不打包 Lambda）
npm run backend:build

# 代码质量
npm run lint
npm run format

# 单元测试（在各 workspace 内执行）
npm test
```
说明：根脚本通过 Yarn Workspaces 统一调用各子工程脚本；也可以进入 `backend/` 独立执行。

### 6. 代码规范与模块组织
- 风格：ESLint + Prettier（2 空格缩进、singleQuote、semi、trailingComma）
- 命名：文件 kebab-case；类/接口 PascalCase；变量/函数 camelCase
- 路径别名：优先使用 `@/` 导入（参见 `backend/tsconfig.json`）
- 模块结构：`backend/src/modules/<feature>/{*.module,*.service,*.controller}.ts`
- 提交规范：Conventional Commits，例如 `feat(user): add profile API`

---

## 如何部署不同环境（Dev / Prod）

本模板使用 AWS CDK 管理基础设施，并将 NestJS 构建为 Lambda 函数，通过 API Gateway 对外提供服务。部署前请确保：

- 已完成 AWS CLI 登录：`aws configure`
- 首次在账户/区域使用 CDK 已完成 bootstrap：
  ```bash
  cd infrastructure
  cdk bootstrap
  cd ..
  ```

### 1. 环境与命名约定
- 环境标识：`dev`、`prod`（通过 `--context environment=<env>` 传入）
- Stack 命名：默认使用 `linuo-aws-template-<env>`；可通过 `--context stackName=<name>` 覆盖
- 项目名前缀：可用 `PROJECT_NAME` 环境变量影响资源与 Stack 前缀（默认 `linuo-aws-template`）

参考（见 `infrastructure/bin/app.ts`）：
- 未显式传入 `stackName` 时，Stack 名为 `${PROJECT_NAME}-${environment}`
- 传入 `stackName` 时，会优先使用它，并尝试从中派生 `projectName`

### 2. 打包 Lambda 并部署
推荐使用根脚本（已封装打包与 CDK 部署流程）：

```bash
# Development
yarn deploy:dev
# 或
npm run deploy:dev

# Production
yarn deploy:prod
# 或
npm run deploy:prod
```
上述脚本等价于：
1) 构建 Lambda 包（`backend:build:lambda` → `scripts/build-lambda.sh` 产物到 `lambda-package/`）
2) 执行 CDK 部署（`infrastructure/` 内 `cdk deploy`），并传入 `--context environment=dev|prod` 和默认 StackName

如需仅对比变更或仅部署基础设施：
```bash
# 仅对比
yarn cdk:diff:dev
yarn cdk:diff:prod

# 仅部署
yarn cdk:deploy:dev
yarn cdk:deploy:prod
```

自定义 Stack 名示例：
```bash
# 部署自定义名称（将覆盖默认 linuo-aws-template-<env>）
npm run cdk:deploy:dev -- --context stackName=my-awesome-app-dev
```

### 3. 销毁环境
```bash
# Destroy Dev
yarn destroy:lambda:dev  # 等同 cdk destroy --context environment=dev

# Destroy Prod
yarn destroy:lambda:prod
```
也可使用：`yarn cdk:destroy:dev` / `yarn cdk:destroy:prod`。

### 4. 部署后验证
- 在 CloudFormation 控制台查看对应 Stack 的 Outputs，获取 API Gateway URL
- 访问健康检查：`GET {apiBase}/health`
- 非生产环境可访问 Swagger：`{apiBase}/docs`
- 若启用鉴权，先执行登录流程获取 JWT 并在 Swagger Authorize 中设置

### 5. Lambda 打包策略（要点）
- 入口：`backend/src/lambda.ts`；webpack 配置在根目录 `webpack.lambda.config.js`
- 打包脚本：`scripts/build-lambda.sh`；产物目录：`lambda-package/`
- 依赖策略：尽量将依赖打入 bundle，`swagger-ui-dist` 作为 external 并复制静态资源
- 生产环境默认关闭 Swagger（通过环境变量控制）

如需引入需要“运行时文件存在”的依赖或 Nest 可选子模块（microservices/websockets），请相应调整 webpack 配置与复制脚本。

---

## 常见问题（排查）
- AWS 凭证缺失：执行 `aws configure` 或导出环境变量 `AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY`
- 首次部署报 bootstrap：进入 `infrastructure` 执行 `cdk bootstrap`
- 端口占用：修改 `backend/.env` 中 `PORT` 或释放端口（如 `lsof -ti:3000 | xargs kill -9`）
- 生产无 Swagger：预期行为，生产默认禁用文档路由
- 鉴权 401/403：检查 JWT 配置与 Cognito 变量，或使用开放路由验证健康检查

---

## 工作流建议
- 开发：`backend:start:dev` → `lint/format/test` → `backend:build`
- 预检：`cdk:diff:<env>` 确认资源变更
- 部署：`deploy:<env>`（或显式 `cdk:deploy:<env>`）
- 回滚：通过 CloudFormation 控制台回滚至上次成功版本，或在 Git 回退后重新部署

---

## 参考脚本（根 package.json）
- 开发：`backend:start:dev`
- 构建：`backend:build`、`backend:build:lambda`、`build:lambda`
- 测试/质量：`test`、`lint`、`format`
- 基础设施：`cdk:diff:dev|prod`、`cdk:deploy:dev|prod`、`cdk:destroy:dev|prod`
- 一键部署：`deploy:dev|prod`（含 Lambda 打包）

如需扩展 CI/CD，可在流水线中按上述顺序编排命令。

---

如对模板有建议或需求，欢迎在仓库提 Issue 讨论与共建。
